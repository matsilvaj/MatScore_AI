<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Análise Gratuita - MatScore AI</title>
    <style>
        body { font-family: sans-serif; max-width: 900px; margin: auto; padding: 1em; }
        nav { text-align: right; padding: 10px; background-color: #f2f2f2; margin-bottom: 2em; border-radius: 8px;}
        .league-container { margin-bottom: 2em; }
        .league-header { background-color: #f7f7f7; padding: 10px; border-radius: 8px 8px 0 0; border: 1px solid #ccc; border-bottom: 2px solid #ccc; }
        .match-card { border: 1px solid #ccc; border-top: none; border-radius: 0 0 8px 8px; margin-bottom: 1em; padding: 1em; }
        .skeleton { animation: pulse 1.5s ease-in-out infinite; background-color: #f0f0f0; border-radius: 8px; padding: 1.5em; margin-bottom: 1em; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .cta-box { background-color: #e7f3ff; border-left: 6px solid #2196F3; padding: 15px; margin-top: 2em; margin-bottom: 2em; }
    </style>
</head>
<body>
    <nav>
        {% if current_user.is_authenticated %}
            <a href="{{ url_for('main.dashboard') }}"><strong>Meu Dashboard</strong></a>
            <a href="{{ url_for('main.logout') }}" style="margin-left: 15px;">Logout</a>
        {% else %}
            <a href="{{ url_for('main.login') }}">Login</a>
            <a href="{{ url_for('main.register') }}" style="margin-left: 15px;">Registrar</a>
        {% endif %}
    </nav>

    <h1>Analisador Esportivo Gratuito</h1>
    <div class="cta-box">
        <p><b>Gostou?</b> <a href="{{ url_for('main.register') }}">Crie uma conta gratuita</a> para desbloquear o acesso a TODAS as ligas!</p>
    </div>

    <div class="search-controls">
        <label for="date-picker">Selecione a data:</label>
        <input type="date" id="date-picker">
    </div>
    <div id="resultados-container"></div>

    <script>
        // O script é praticamente idêntico ao do dashboard, mas aponta para a API pública
        document.addEventListener('DOMContentLoaded', function() {
            const container = document.getElementById('resultados-container');
            const datePicker = document.getElementById('date-picker');
            let eventSource = null;

            datePicker.value = new Date().toISOString().split('T')[0];
            fetchAnalyses();

            datePicker.addEventListener('change', fetchAnalyses);

            function fetchAnalyses() {
                if (eventSource) {
                    eventSource.close();
                }
                const selectedDate = datePicker.value;
                if (!selectedDate) return;

                container.innerHTML = `<h2>Análises para ${selectedDate}</h2>`;
                // Não adicionamos o esqueleto aqui, vamos adicioná-lo dentro de cada liga

                const apiUrl = window.location.pathname.includes('/dashboard') ? `/api/analise/private?date=${selectedDate}` : `/api/analise/public?date=${selectedDate}`;
                eventSource = new EventSource(apiUrl);

                let currentLeagueContainer = null;

                eventSource.onmessage = function(event) {
                    const resultado = JSON.parse(event.data);
                    
                    // Remove qualquer esqueleto existente antes de processar a nova mensagem
                    const existingSkeleton = container.querySelector('.skeleton');
                    if (existingSkeleton) {
                        existingSkeleton.remove();
                    }

                    if (resultado.status) {
                        switch (resultado.status) {
                            case 'league_start':
                                const leagueId = resultado.liga_nome.replace(/\s+/g, '-').toLowerCase();
                                container.insertAdjacentHTML('beforeend', `
                                    <div class="league-container" id="container-${leagueId}">
                                        <div class="league-header"><strong>${resultado.liga_nome}</strong></div>
                                    </div>
                                `);
                                currentLeagueContainer = document.getElementById(`container-${leagueId}`);
                                // Adiciona um esqueleto dentro da nova liga
                                currentLeagueContainer.insertAdjacentHTML('beforeend', `<div class="skeleton pulse"><div style="height: 20px; background-color: #e0e0e0; border-radius: 4px;"></div></div>`);
                                break;
                            case 'no_games':
                                container.innerHTML += `<p>Nenhum jogo encontrado para a data selecionada.</p>`;
                                break;
                            case 'done':
                                container.insertAdjacentHTML('beforeend', `<p style="text-align: center; font-weight: bold; color: green;">✅ Busca Concluída!</p>`);
                                eventSource.close();
                                break;
                        }
                        return;
                    }

                    if (!currentLeagueContainer) return;

                    const cardHtml = `
                        <div class="match-card">
                            <h3>${resultado.mandante_nome} vs ${resultado.visitante_nome}</h3>
                            <p><b>Cenário de Maior Probabilidade:</b> ${resultado.recomendacao}</p>
                            <details>
                                <summary>Ver Análise Detalhada</summary>
                                <div>${resultado.detalhes.join('<br>')}</div>
                            </details>
                        </div>
                    `;
                    currentLeagueContainer.insertAdjacentHTML('beforeend', cardHtml);
                    // Adiciona um novo esqueleto após o card, para o próximo jogo
                    currentLeagueContainer.insertAdjacentHTML('beforeend', `<div class="skeleton pulse"><div style="height: 20px; background-color: #e0e0e0; border-radius: 4px;"></div></div>`);
                };

                eventSource.onerror = function() {
                    eventSource.close();
                    const skeleton = container.querySelector('.skeleton');
                    if (skeleton) {
                        skeleton.outerHTML = '<p style="color: red; text-align: center;">Erro ao conectar com o servidor.</p>';
                    }
                };
            }
        });
    </script>
</body>
</html>